<!DOCTYPE html>
<html lang="zh-CN">
<head>
    <meta charset="UTF-8">
    <script src="https://cdn.plot.ly/plotly-2.27.0.min.js"></script>
    <style>
        * {
            margin: 0;
            padding: 0;
            box-sizing: border-box;
        }
        body {
            font-family: "Microsoft Yahei", sans-serif;
        }
        h1 {
            text-align: center;
            margin: 20px 0 10px;
            color: #333;
        }
        .subtitle {
            text-align: center;
            color: #666;
            margin-bottom: 20px;
            font-size: 14px;
        }
        #map {
            width: 95%;
            height: 700px;
            margin: 0 auto;
            pointer-events: auto !important;
        }
        #posterModal {
            display: none;
            position: fixed;
            top: 0;
            left: 0;
            width: 100%;
            height: 100%;
            background-color: rgba(0, 0, 0, 0.7);
            z-index: 9999;
            justify-content: center;
            align-items: center;
            padding: 20px;
        }
        .modal-content {
            background-color: white;
            width: 90%;
            max-width: 1200px;
            max-height: 90vh;
            border-radius: 10px;
            padding: 20px;
            position: relative;
            overflow-y: auto;
        }
        .close-btn {
            position: absolute;
            top: 15px;
            right: 20px;
            font-size: 24px;
            font-weight: bold;
            color: #666;
            cursor: pointer;
            transition: color 0.2s;
            z-index: 10;
        }
        .close-btn:hover {
            color: #ff4444;
        }
        #posterTitle {
            font-size: 20px;
            font-weight: bold;
            margin-bottom: 20px;
            color: #333;
            padding-right: 30px;
        }
        .posterList {
            display: flex;
            flex-wrap: wrap;
            gap: 25px;
            justify-content: center;
        }
        .posterItem {
            width: calc((100% - 125px) / 8); /* 一行6个，减去总间隙 */
            max-width: 180px;
            min-width: 120px;
            text-align: center;
        }
        .posterImg {
            width: 100%;
            height: 180px;
            object-fit: cover;
            border-radius: 8px;
            box-shadow: 0 4px 8px rgba(0,0,0,0.15);
        }
        .posterName {
            margin-top: 10px;
            font-size: 14px;
            color: #444;
            white-space: nowrap;
            overflow: hidden;
            text-overflow: ellipsis;
            padding: 0 5px;
        }
    </style>
</head>
<body>
    <div class="container">
        <h1>豆瓣Top250电影合作国家/地区分布热力图</h1>
        <div class="subtitle">(空白区域表示无合作记录，点击国家查看对应电影海报)</div>
        <div id="map"></div>
    </div>

    <div id="posterModal">
        <div class="modal-content">
            <span class="close-btn" id="closeBtn">&times;</span>
            <div id="posterTitle"></div>
            <div class="posterList" id="posterList"></div>
        </div>
    </div>

    <script>
        let movieCountryMap = {};
        let mapDiv = document.getElementById('map');
        let mapConfig = {
            data: null,
            layout: null
        };

        fetch('./Poster.json')
            .then(response => {
                if (!response.ok) throw new Error(`JSON加载失败: ${response.status}`);
                return response.json();
            })
            .then(rawData => {
                rawData.forEach(item => {
                    const country = item.country?.trim();
                    const movieName = item.movieName?.trim();
                    const posterPath = item.posterPath?.trim();
                    if (!country || !movieName || !posterPath) return;

                    if (!movieCountryMap[country]) movieCountryMap[country] = [];
                    const isDuplicate = movieCountryMap[country].some(m => m.movieName === movieName);
                    if (!isDuplicate) {
                        movieCountryMap[country].push({ movieName, posterPath });
                    }
                });
                initHeatMap();
            })
            .catch(error => {
                console.error("❌ 数据加载失败：", error);
                alert(`数据加载错误：${error.message}`);
                initHeatMap();
            });

        function initHeatMap() {
            mapConfig.data = [{
                type: 'choropleth',
                locations: [
                    'United States', 'China', 'United Kingdom', 'Japan', 'France',
                    'South Korea', 'Germany', 'Italy', 'Canada', 'Australia',
                    'Switzerland', 'New Zealand', 'Spain', 'India', 'Sweden',
                    'Brazil', 'Denmark', 'Iran', 'Thailand', 'Belgium',
                    'Netherlands', 'Poland', 'Austria', 'Ukraine', 'Argentina',
                    'Russia', 'South Africa', 'Egypt', 'Nigeria', 'Kenya',
                    'Saudi Arabia', 'Turkey', 'Indonesia', 'Malaysia', 'Vietnam',
                    'Philippines', 'Pakistan', 'Bangladesh', 'Mexico', 'Chile',
                    'Colombia', 'Peru', 'Norway', 'Finland', 'Greece',
                    'Portugal', 'Hungary', 'Czech Republic', 'Romania', 'Bulgaria'
                ],
                z: [
                    141, 45, 39, 36, 19, 12, 11, 9, 8, 4, 3, 3, 3, 2, 2, 2, 1, 1, 1, 1, 1, 1, 1, 1, 1,
                    0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0
                ],
                locationmode: 'country names',
                colorscale : [
                    [0.0, '#F0A060'],
                    [0.1, '#EB7F40'],
                    [0.2, '#E65F20'],
                    [0.3, '#DC4010'],
                    [0.4, '#D02010'],
                    [0.5, '#B81010'],
                    [0.6, '#D13322'],
                    [0.7, '#B42418'],
                    [0.8, '#911C15'],
                    [0.9, '#6F1611'],
                    [1, '#6F1611'],
                ],

                zmin: 0,
                zmax: 150,
                colorbar: {
                    title: '合作次数（部）',
                    thickness: 20,
                    len: 0.75,
                    y: 0.5,
                    x: 0.92,
                },
                hovertemplate: '<b>%{location}</b><br>合作制作电影数量: %{z:.0f} 部<extra></extra>',
                selected: { marker: { opacity: 1 } },
                unselected: { marker: { opacity: 1 } }
            }];
            mapConfig.layout = {
                height: 700,
                margin: { l: 0, r: 0, t: 0, b: 0 },
                dragmode: 'zoom',
                clickmode: 'event+select',
                geo: {
                    showframe: false,
                    showcoastlines: true,
                    projection: { type: 'equirectangular' },
                    center: { lat: 0, lon: 0 },
                    zoom: 1,
                    scale: 1,
                    lataxis: { range: [-90, 90] },
                    lonaxis: { range: [-180, 180] },
                    selected: { opacity: 1 },
                    unselected: { opacity: 1 }
                }
            };

            renderMap();
        }

        function renderMap() {
            Plotly.purge(mapDiv);
            Plotly.newPlot(mapDiv, mapConfig.data, mapConfig.layout).then(() => {
                mapDiv.on('plotly_click', function(event) {
                    const clickedCountry = event?.points?.[0]?.location;
                    if (clickedCountry) {
                        showMoviePosterModal(clickedCountry);
                        Plotly.restyle(mapDiv, 'selectedpoints', [[]]);
                    }
                });
            }).catch(err => {
                console.error("❌ 地图渲染失败：", err);
                alert("地图加载失败：" + err.message);
            });
        }

        function showMoviePosterModal(country) {
            const movies = movieCountryMap[country] || [];
            const modal = document.getElementById('posterModal');
            const posterTitle = document.getElementById('posterTitle');
            const posterList = document.getElementById('posterList');

            posterList.innerHTML = '';
            if (movies.length === 0) {
                posterTitle.textContent = `${country}：暂无合作电影海报`;
            } else {
                posterTitle.textContent = `${country} 合作电影海报（共${movies.length}部）`;
                movies.forEach(movie => {
                    const posterItem = document.createElement('div');
                    posterItem.className = 'posterItem';
                    posterItem.innerHTML = `
                        <img class="posterImg"
                             src="${movie.posterPath}"
                             alt="${movie.movieName}的海报"
                             title="${movie.movieName}"
                             onerror="this.src='https://via.placeholder.com/180x270?text=${encodeURIComponent(movie.movieName)}'">
                        <div class="posterName" title="${movie.movieName}">${movie.movieName}</div>
                    `;
                    posterList.appendChild(posterItem);
                });
            }
            modal.style.display = 'flex';
        }

        function closeModalAndResetMap() {
            document.getElementById('posterModal').style.display = 'none';
            setTimeout(() => {
                renderMap();
            }, 30);
        }
        document.getElementById('closeBtn').addEventListener('click', closeModalAndResetMap);
        document.getElementById('posterModal').addEventListener('click', function(e) {
            if (e.target === this) closeModalAndResetMap();
        });
        document.addEventListener('keydown', function(e) {
            if (e.key === 'Escape') closeModalAndResetMap();
        });
    </script>
</body>
</html>