<!DOCTYPE html>
<html lang="zh-CN">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <script src="https://d3js.org/d3.v7.min.js"></script>
    <style>
        * {
            margin: 0;
            padding: 0;
            box-sizing: border-box;
        }

        body {
            font-family: "Microsoft YaHei", Arial, sans-serif;
            background-color: #000000;
            padding: 20px;
        }

        .chart-container {
            background: black;
            border-radius: 8px;
            box-shadow: 0 2px 10px rgba(0,0,0,0.1);
            padding: 30px;
            max-width: 1200px;
            margin: 0 auto;
            position: relative;
            height: 700px;
        }

        h1 {
            color: #fff;
            text-align: center;
            margin-bottom: 30px;
            font-size: 24px;
        }

        .tooltip {
            position: absolute;
            background: rgba(0,0,0,0.85);
            color: white;
            padding: 10px;
            border-radius: 6px;
            font-size: 14px;
            pointer-events: none;
            opacity: 0;
            transition: opacity 0.2s ease;
            z-index: 9999;
            box-shadow: 0 2px 10px rgba(0,0,0,0.3);
        }

        .tooltip img {
            width: 120px;
            height: auto;
            border-radius: 4px;
            margin-bottom: 8px;
            display: block;
        }

        .axis-label {
            font-size: 14px;
            fill: #fff;
            font-weight: bold;
        }

        .legend {
            position: absolute;
            top: 80px;
            right: 30px;
            background: black;
            padding: 15px;
            border-radius: 6px;
            box-shadow: 0 2px 8px rgba(0,0,0,0.1);
            z-index: 100;
        }

        .legend-title {
            font-weight: bold;
            margin-bottom: 10px;
            color: #fff;
        }

        .legend-item {
            display: flex;
            align-items: center;
            margin: 8px 0;
            color: #fff;
        }

        .legend-color {
            width: 15px;
            height: 15px;
            border-radius: 50%;
            margin-right: 8px;
        }

        .theme-label {
            font-size: 12px;
            fill: #fff;
        }

        .axis line, .axis path {
            stroke: #fff;
            stroke-width: 1px;
        }

        .connection-line {
            stroke: #fff;
            stroke-width: 1px;
            stroke-dasharray: 2, 2;
            opacity: 0.7;
            transition: all 0.2s ease;
        }

        .movie-name {
            font-size: 11px;
            fill: #fff;
            font-weight: 500;
            pointer-events: none;
            text-anchor: middle;
            dominant-baseline: hanging;
            transition: all 0.2s ease;
        }

        .poster-container {
            pointer-events: none;
            z-index: 1;
            transition: opacity 0.2s ease;
        }

        .poster-wrap {
            width: 100%;
            height: 100%;
            border-radius: 50%;
            border: 3px solid;
            padding: 2px;
            box-sizing: border-box;
            transition: border-width 0.2s ease;
        }

        .poster-image {
            width: 100%;
            height: 100%;
            object-fit: cover;
            border-radius: 50%;
        }

        .theme-bg {
            width: 100%;
            height: 100%;
            border-radius: 50%;
            display: flex;
            align-items: center;
            justify-content: center;
            color: white;
            font-size: 12px;
            font-weight: bold;
            padding: 5px;
            text-align: center;
        }

        .interaction-circle {
            cursor: pointer;
            fill: transparent;
            stroke: transparent;
            stroke-width: 0;
            z-index: 10;
            transition: all 0.2s ease;
        }

        .faded {
            opacity: 0.2;
        }

        .movie-name.highlight {
            font-weight: bold;
            fill: #fff;
            font-size: 12px;
        }

        .poster-wrap.highlight {
            border-width: 4px;
            filter: drop-shadow(0 0 4px rgba(0,0,0,0.2));
        }
    </style>
</head>
<body>
    <div class="chart-container">
        <h1>科幻电影的三巨头：人文、时空与赛博朋克</h1>
        <div id="chart"></div>
        <div class="legend" id="legend"></div>
    </div>

    <script>

        const movieData = [
            ["星际穿越", 0, 169, 9.4, 67750, "./posters/7_星际穿越_p2614988097.webp"],
            ["盗梦空间", 1, 148, 9.4, 82560, "./posters/9_盗梦空间_p513344864.webp"],
            ["楚门的世界", 0, 103, 9.4, 26410, "./posters/10_楚门的世界_p479682972.webp"],
            ["机器人总动员", 0, 98, 9.3, 52130, "./posters/16_机器人总动员_p1461851991.webp"],
            ["2001太空漫游", 0, 149, 8.9, 5620, "./posters/184_2001太空漫游_p2560717825.webp"],
            ["阿凡达", 0, 162, 8.8, 292370, "./posters/74_阿凡达_p2180085848.webp"],
            ["超能陆战队", 0, 102, 8.8, 65780, "./posters/108_超能陆战队_p2224568669.webp"],
            ["头号玩家", 2, 140, 8.6, 58220, "./posters/155_头号玩家_p2516578307.webp"],
            ["人工智能", 0, 146, 8.7, 23590, "./posters/224_人工智能_p792257137.webp"],
            ["黑客帝国2", 2, 138, 8.7, 73880, "./posters/236_黑客帝国2：重装上阵_p443461390.webp"],
            ["攻壳机动队", 0, 83, 9.0, 400, "./posters/243_攻壳机动队_p2921045013.webp"],
            ["蝙蝠侠：黑暗骑士", 0, 153, 9.2, 100460, "./posters/31_蝙蝠侠：黑暗骑士_p462657443.webp"],
            ["终结者2", 2, 137, 8.8, 52080, "./posters/220_终结者2：审判日_p1910909085.webp"],
            ["黑客帝国", 2, 136, 9.1, 46350, "./posters/54_黑客帝国_p451926968.webp"],
            ["黑客帝国3", 2, 129, 8.8, 42730, "./posters/167_黑客帝国3：矩阵革命_p443461818.webp"],
            ["蝴蝶效应", 1, 113, 8.9, 9600, "./posters/81_蝴蝶效应_p2209066019.webp"],
            ["红辣椒", 1, 90, 9.0, 1010, "./posters/98_红辣椒_p2794776839.webp"],
            ["蝙蝠侠：黑暗骑士崛起", 0, 164, 8.9, 108490, "./posters/105_蝙蝠侠：黑暗骑士崛起_p1706428744.webp"],
            ["源代码", 1, 93, 8.6, 12320, "./posters/204_源代码_p988260245.webp"],
            ["千钧一发", 1, 106, 8.8, 3650, "./posters/227_千钧一发_p792423963.webp"],
            ["彗星来的那一夜", 1, 89, 8.6, 410, "./posters/232_彗星来的那一夜_p2187896734.webp"],
            ["恐怖游轮", 1, 98, 8.5, 1160, "./posters/193_恐怖游轮_p462470694.webp"]
        ];

        const themeMap = {
            0: "人文情怀",
            1: "时空循环",
            2: "赛博朋克"
        };

        const themeColors = {
            0: "#3498db",
            1: "#e74c3c",
            2: "#2ecc71",
            3: "#f39c12"
        };

        const processedData = movieData.map(item => ({
            name: item[0],
            theme: item[1],
            themeName: themeMap[item[1]],
            duration: item[2],
            rating: item[3],
            boxOffice: item[4],
            posterPath: item[5]
        }));

        const width = 1000;
        const height = 650;
        const margin = { top: 60, right: 180, bottom: 80, left: 80 };

        const innerWidth = width - margin.left - margin.right;
        const innerHeight = height - margin.top - margin.bottom;

        const svg = d3.select("#chart")
            .append("svg")
            .attr("width", width)
            .attr("height", height)
            .append("g")
            .attr("transform", `translate(${margin.left}, ${margin.top})`);

        const tooltip = d3.select(".chart-container")
            .append("div")
            .attr("class", "tooltip");

        const ratingMin = d3.min(processedData, d => d.rating) - 0.1;
        const ratingMax = d3.max(processedData, d => d.rating) + 0.1;
        const xScale = d3.scaleLinear()
            .domain([ratingMin, ratingMax])
            .range([0, innerWidth]);

        const yMin = 70;
        const yMax = d3.max(processedData, d => d.duration)+40;
        const yScale = d3.scaleLinear()
            .domain([yMin, yMax])
            .range([innerHeight, 0]);

        const boxOfficeExtent = d3.extent(processedData, d => d.boxOffice);
        const radiusScale = d3.scaleSqrt()
            .domain(boxOfficeExtent)
            .range([20, 70]);

        svg.append("g")
            .attr("class", "axis")
            .attr("transform", `translate(0, ${innerHeight})`)
            .call(d3.axisBottom(xScale).ticks(10))
            .selectAll("text")
            .attr("class", "theme-label")
            .attr("font-size", "14px");

        svg.append("g")
            .attr("class", "axis")
            .call(d3.axisLeft(yScale).ticks(10))
            .selectAll("text")
            .attr("class", "theme-label")
            .attr("font-size", "14px");

        svg.append("text")
            .attr("x", innerWidth / 2)
            .attr("y", innerHeight + margin.bottom - 20)
            .attr("text-anchor", "middle")
            .attr("class", "axis-label")
            .text("电影评分");

        svg.append("text")
            .attr("transform", "rotate(-90)")
            .attr("x", -innerHeight / 2)
            .attr("y", -margin.left + 20)
            .attr("text-anchor", "middle")
            .attr("class", "axis-label")
            .text("时长（分钟）");

        processedData.forEach(movie => {
            const circleRadius = radiusScale(movie.boxOffice);
            const ratingX = xScale(movie.rating);
            const durationY = yScale(movie.duration);

            let centerX = ratingX;
            let centerY = durationY - circleRadius;
            centerX = Math.max(circleRadius + 10, Math.min(innerWidth - circleRadius - 10, centerX));
            centerY = Math.max(circleRadius + 20, Math.min(innerHeight - circleRadius - 30, centerY));

            movie.finalX = centerX;
            movie.finalY = centerY;
            movie.circleRadius = circleRadius;
            movie.durationY = durationY;
            movie.nameY = centerY + circleRadius + 5;
        });

        const connectionLines = svg.selectAll(".connection-line")
            .data(processedData)
            .enter()
            .append("line")
            .attr("class", "connection-line")
            .attr("x1", d => d.finalX)
            .attr("y1", d => d.durationY)
            .attr("x2", d => d.finalX)
            .attr("y2", innerHeight)
            .attr("stroke", d => themeColors[d.theme])
            .attr("stroke-width", 1)
            .attr("opacity", 0.4)

        const posterContainers = svg.selectAll(".poster-container")
            .data(processedData)
            .enter()
            .append("foreignObject")
            .attr("class", "poster-container")
            .attr("x", d => d.finalX - d.circleRadius)
            .attr("y", d => d.finalY - d.circleRadius)
            .attr("width", d => d.circleRadius * 2)
            .attr("height", d => d.circleRadius * 2)
            .lower();

        posterContainers.append("xhtml:div")
            .attr("class", "poster-wrap")
            .style("border-color", d => themeColors[d.theme])
            .html(d => {
                if (d.posterPath && d.posterPath.trim()) {
                    return `<img src="${d.posterPath}" class="poster-image" alt="${d.name}海报" />`;
                }
                else {
                    return `<div class="theme-bg" style="background-color:${themeColors[d.theme]}">${d.themeName}</div>`;
                }
            });

        const movieNames = svg.selectAll(".movie-name")
            .data(processedData)
            .enter()
            .append("text")
            .attr("class", "movie-name")
            .attr("x", d => d.finalX)
            .attr("y", d => d.nameY)
            .text(d => d.name)
            .each(function(d) {
                const text = d3.select(this);
                const name = d.name;
                if (name.length > 8) {
                    text.text("");
                    text.append("tspan")
                        .attr("x", d.finalX)
                        .attr("dy", "0em")
                        .text(name.substring(0, 8));
                    text.append("tspan")
                        .attr("x", d.finalX)
                        .attr("dy", "1.2em")
                        .text(name.substring(8));
                }
            });

        const interactionCircles = svg.selectAll(".interaction-circle")
            .data(processedData)
            .enter()
            .append("circle")
            .attr("class", "interaction-circle")
            .attr("cx", d => d.finalX)
            .attr("cy", d => d.finalY)
            .attr("r", d => d.circleRadius)
            .attr("fill", "transparent")
            .attr("stroke", "transparent")
            .attr("stroke-width", 0)
            .on("mouseover", function(event, d) {
                console.log("hover:", d.name);

                svg.selectAll(".poster-container")
                    .filter(posterD => posterD.name !== d.name)
                    .classed("faded", true);

                svg.selectAll(".movie-name")
                    .filter(nameD => nameD.name !== d.name)
                    .attr("opacity", 0.2);

                svg.selectAll(".connection-line")
                    .filter(lineD => lineD.name !== d.name)
                    .attr("opacity", 0.1);

                svg.selectAll(".poster-container")
                    .filter(posterD => posterD.name === d.name)
                    .classed("faded", false)
                    .select(".poster-wrap")
                    .classed("highlight", true);

                svg.selectAll(".movie-name")
                    .filter(nameD => nameD.name === d.name)
                    .classed("highlight", true)
                    .attr("fill", themeColors[d.theme])
                    .attr("opacity", 1);

                svg.selectAll(".connection-line")
                    .filter(lineD => lineD.name === d.name)
                    .attr("opacity", 1)
                    .attr("stroke-width", 2)
                    .attr("stroke-dasharray", "none");

                svg.append("line")
                    .attr("class", "duration-reference")
                    .attr("x1", 0)
                    .attr("y1", d.durationY)
                    .attr("x2", innerWidth)
                    .attr("y2", d.durationY)
                    .attr("stroke", themeColors[d.theme])
                    .attr("stroke-width", 1)
                    .attr("stroke-dasharray", "5,5")
                    .attr("opacity", 0.8);

                let posterHtml = d.posterPath && d.posterPath.trim()
                    ? `<img src="${d.posterPath}" alt="${d.name}海报" />`
                    : "";

                tooltip.style("opacity", 1)
                    .html(`
                        ${posterHtml}
                        <div><strong>${d.name}</strong></div>
                        <div>主题: ${d.themeName}</div>
                        <div>时长: ${d.duration}分钟</div>
                        <div>评分: ${d.rating}</div>
                        <div>票房: ${d.boxOffice.toLocaleString()}万美元</div>
                    `)
            })
            .on("mouseout", function(event, d) {
                svg.selectAll(".poster-container")
                    .classed("faded", false)
                    .select(".poster-wrap")
                    .classed("highlight", false);

                svg.selectAll(".movie-name")
                    .classed("highlight", false)
                    .attr("font-weight", "500")
                    .attr("fill", "#333")
                    .attr("font-size", "11px")
                    .attr("opacity", 1);

                svg.selectAll(".connection-line")
                    .attr("opacity", 0.4)
                    .attr("stroke-width", 1)
                    .attr("stroke-dasharray", "2, 2");

                svg.selectAll(".duration-reference").remove();

                tooltip.style("opacity", 0);
            })
            .on("mousemove", function(event) {
                tooltip.style("left", (event.clientX - 50) + "px")
                       .style("top", (event.clientY - 100) + "px");
            });

        const legend = d3.select("#legend");
        legend.append("div")
            .attr("class", "legend-title")
            .text("电影主题（颜色）");

        Object.keys(themeMap).forEach(theme => {
            const legendItem = legend.append("div")
                .attr("class", "legend-item")

            legendItem.append("div")
                .attr("class", "legend-color")
                .style("background-color", themeColors[theme]);

            legendItem.append("div")
                .text(themeMap[theme]);
        });

        legend.append("div")
            .attr("class", "legend-title")
            .style("margin-top", "15px")
            .text("票房（圆形大小）");

        boxOfficeExamples.forEach(example => {
            const item = legend.append("div")
                .attr("class", "legend-item")
                .style("align-items", "center");

            item.append("svg")
                .attr("width", 30)
                .attr("height", 30)
                .append("circle")
                .attr("cx", 15)
                .attr("cy", 15)
                .attr("r", radiusScale(example.value))
                .attr("fill", "#ccc")
                .attr("stroke", "#999");

            item.append("div")
                .text(`${example.label}万美元`)
                .style("margin-left", "10px");
        });
    </script>
</body>
</html>